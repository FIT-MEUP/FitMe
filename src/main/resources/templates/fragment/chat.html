<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>채팅 - 파일 업로드</title>

  <style>
    /* 채팅 영역 스타일 */
    .conversation {
      max-height: 500px;
      overflow-y: auto;
      padding: 10px;
      border: 1px solid #ddd;
      background: #fff;
    }
    .message {
      margin-bottom: 10px;
      padding: 5px;
    }
    .message.sender {
      text-align: right;
      color: blue;
    }
    .message.receiver {
      text-align: left;
      color: green;
    }

    /* 입력창 컨테이너 */
    .input-container {
      margin-top: 10px;
      position: relative; /* 이미지 버튼을 절대 배치하기 위해 */
    }
    /* 텍스트 입력창 */
    .input-container input[type="text"] {
      width: calc(100% - 70px); /* 전송버튼 + 이미지버튼 공간 확보 */
      padding: 8px;
      box-sizing: border-box;
    }
    /* 전송 버튼 */
    .input-container button {
      padding: 8px 12px;
      margin-left: 5px;
    }
    /* 이미지 버튼 (plus.png) 위치: input 내부 오른쪽에 겹쳐 보이도록 */
    .file-button {
      position: absolute;
      top: 8px;
      right: 10px;
      cursor: pointer;
      width: 20px;   /* 원하는 크기로 조정 */
      height: 20px;  /* 원하는 크기로 조정 */
    }
    /* 숨겨진 파일 입력 */
    #fileInput {
      display: none;
    }
  </style>
</head>

<body>

<!-- chat.html 프래그먼트 시작 -->
<div th:fragment="chatFragment">

  <!-- (A) 숨김 div: 현재 사용자, 대상 사용자 정보 보관 -->
  <div id="chatData" style="display:none;"
       th:attr="data-current-user-id=${currentUser.userId},
                data-current-user-name=${currentUser.userName},
                data-target-user-id=${targetUser.userId},
                data-target-user-name=${targetUser.userName}">
  </div>

  <!-- (B) 대화 영역 -->
  <div id="conversationArea" class="conversation">
    <th:block th:if="${conversation != null and !#lists.isEmpty(conversation)}">
      <div th:each="msg : ${conversation}">
        <!-- msg.senderId == currentUserId → 'message sender', 아니면 'message receiver' -->
        <div th:class="${(msg.senderId eq currentUser.userId) ? 'message sender' : 'message receiver'}">

          <strong th:text="${(msg.senderId eq currentUser.userId) ? currentUser.userName : targetUser.userName}">
            Sender
          </strong>:

          <!-- (B-1) 파일 메시지인지 체크 -->
          <th:block th:if="${msg.fileUrl != null}">
            <th:block th:switch="${msg.fileType}">

              <!-- 이미지 파일 -->
              <th:block th:case="'image'">
                <img th:src="${msg.fileUrl}" alt="이미지" style="max-width:200px;" />
                <br/>
                <a th:href="${msg.fileUrl}" th:download="${msg.originalFileName}">
                  [[${msg.originalFileName}]]
                </a>
              </th:block>

              <!-- 비디오 파일 -->
              <th:block th:case="'video'">
                <video controls width="300">
                  <source th:src="${msg.fileUrl}" type="video/mp4" />
                  영상 재생 불가
                </video>
                <br/>
                <a th:href="${msg.fileUrl}" th:download="${msg.originalFileName}">
                  [[${msg.originalFileName}]]
                </a>
              </th:block>

              <!-- 오디오 파일 -->
              <th:block th:case="'audio'">
                <audio controls>
                  <source th:src="${msg.fileUrl}" type="audio/mpeg" />
                  오디오 재생 불가
                </audio>
                <br/>
                <a th:href="${msg.fileUrl}" th:download="${msg.originalFileName}">
                  [[${msg.originalFileName}]]
                </a>
              </th:block>

              <!-- 기타 문서 -->
              <th:block th:case="*">
                <a th:href="${msg.fileUrl}" th:download="${msg.originalFileName}">
                  [[${msg.originalFileName}]]
                </a>
              </th:block>
            </th:block>
          </th:block>

          <!-- (B-2) 텍스트 메시지 -->
          <th:block th:if="${msg.fileUrl} == null">
            <span th:text="${msg.content}">메시지</span>
          </th:block>
        </div>
      </div>
    </th:block>

    <th:block th:if="${conversation == null or #lists.isEmpty(conversation)}">
      <p>대화 내용을 보려면 상대방을 선택하세요.</p>
    </th:block>
  </div>

  <!-- (C) 채팅 입력창 -->
  <div class="input-container">
    <!-- 텍스트 메시지 입력 -->
    <input type="text" id="newMessage" placeholder="메시지를 입력하세요"/>
    <button type="button" id="sendBtn">전송</button>

    <!-- (C-1) plus.png 이미지 버튼 (클릭 시 파일 업로드) -->
    <img src="/images/plus.png"
         id="fileSelectIcon"
         class="file-button"
         alt="파일 첨부 버튼"/>

    <!-- (C-2) 숨김 파일 입력 (accept 속성 없이 모든 파일 가능) -->
    <input type="file" id="fileInput" style="display:none;"/>
  </div>

</div>
<!-- chat.html 프래그먼트 끝 -->

<script>
  function initChat() {
    // STOMP 메시지를 받았을 때 화면에 표시
    window.updateChatWindow = function(chat) {
      const conversationArea = document.getElementById("conversationArea");
      const messageDiv = document.createElement("div");
      messageDiv.classList.add("message");

      // sender vs receiver
      if (chat.senderId === window.currentUser.userId) {
        messageDiv.classList.add("sender");
      } else {
        messageDiv.classList.add("receiver");
      }

      let senderName = (chat.senderId === window.currentUser.userId)
          ? window.currentUser.userName
          : window.targetUser.userName;

      // 파일 메시지?
      if (chat.fileUrl && chat.fileType) {
        let filePreview = "";
        switch (chat.fileType) {
          case "image":
            filePreview = `<img src="${chat.fileUrl}" alt="이미지" style="max-width:200px;">`;
            break;
          case "video":
            filePreview = `
              <video controls width="300">
                <source src="${chat.fileUrl}" type="video/mp4"/>
                영상 재생 불가
              </video>`;
            break;
          case "audio":
            filePreview = `
              <audio controls>
                <source src="${chat.fileUrl}" type="audio/mpeg"/>
                오디오 재생 불가
              </audio>`;
            break;
          default:
            const docName = chat.originalFileName || "파일";
            filePreview = `<a href="${chat.fileUrl}" download="${docName}">${docName}</a>`;
            break;
        }
        messageDiv.innerHTML = `<strong>${senderName}</strong>: ${filePreview}`;
      } else {
        // 텍스트 메시지
        messageDiv.innerHTML = `<strong>${senderName}</strong>: <span>${chat.content}</span>`;
      }

      conversationArea.appendChild(messageDiv);
      conversationArea.scrollTop = conversationArea.scrollHeight;
    };

    // 전송 버튼
    const sendBtn = document.getElementById("sendBtn");
    if (sendBtn) {
      sendBtn.addEventListener("click", function() {
        if (typeof sendChatMessage === "function") {
          sendChatMessage();
        } else {
          console.log("sendChatMessage 함수가 정의되어 있지 않습니다.");
        }
      });
    }
  }
</script>

</body>
</html>
