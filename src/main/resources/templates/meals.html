<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>ì‹ë‹¨ ê²Œì‹œíŒ</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    <style>
        .selected-date {
            background-color: #ffeb99 !important;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-light bg-light p-3">
        <button class="btn btn-primary" onclick="history.back();">â† ë’¤ë¡œ ê°€ê¸°</button>
        <h3 class="text-center flex-grow-1">ì‹ë‹¨ ê²Œì‹œíŒ</h3>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-4">
                <h5>ğŸ“… ë‚ ì§œ ì„ íƒ (FullCalendar)</h5>
                <div id="calendar"></div>
            </div>

            <div class="col-md-8">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>ğŸ½ï¸ ì‹ë‹¨ ê¸°ë¡</h5>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#mealModal">+ ì¶”ê°€</button>
                </div>

                <th:block th:if="${meals == null or #lists.isEmpty(meals)}">
                    <p class="text-muted">ë“±ë¡ëœ ì‹ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                </th:block>

                <th:block th:if="${meals != null and not #lists.isEmpty(meals)}">
                    <div class="row">
                        <div class="col-md-6 mb-3" th:each="meal : ${meals}">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title" th:text="${meal.mealDate}"></h5>
                                    <p class="card-text">ì¹¼ë¡œë¦¬: <span th:text="${meal.totalCalories}"></span> kcal</p>
                                    <p class="card-text">íƒ„ìˆ˜í™”ë¬¼: <span th:text="${meal.totalCarbs}"></span> g</p>
                                    <p class="card-text">ë‹¨ë°±ì§ˆ: <span th:text="${meal.totalProtein}"></span> g</p>
                                    <p class="card-text">ì§€ë°©: <span th:text="${meal.totalFat}"></span> g</p>

                                    <p class="fw-bold">ğŸ“Œ í¬í•¨ëœ ìŒì‹:</p>
                                    <ul>
                                        <li th:each="food : ${meal.foodList}" th:text="${food.foodName} + ' (' + food.calories + ' kcal)'"></li>
                                    </ul>
                                    
                                     <!-- âœ… ìˆ˜ì • ë²„íŠ¼ ì¶”ê°€ -->
                                    <button class="btn btn-warning edit-meal-btn"
                                        th:data-mealid="${meal.mealId}"
                                        th:data-mealdate="${meal.mealDate}"
                                        th:data-totalcalories="${meal.totalCalories}"
                                        th:data-totalcarbs="${meal.totalCarbs}"
                                        th:data-totalprotein="${meal.totalProtein}"
                                        th:data-totalfat="${meal.totalFat}"
                                        data-bs-toggle="modal"
                                        data-bs-target="#editMealModal">
                                        ìˆ˜ì •
                                    </button>
								
								<!-- ì‚­ì œ ë²„íŠ¼  -->
                                    <form method="post" action="/meals/delete">
                                        <input type="hidden" name="mealId" th:value="${meal.mealId}">
                                        <button type="submit" class="btn btn-danger">ì‚­ì œ</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </th:block>
            </div>
        </div>
    </div>

    <!-- âœ… ì‹ë‹¨ ì¶”ê°€ ëª¨ë‹¬ -->
    <div class="modal fade" id="mealModal" tabindex="-1" aria-labelledby="mealModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ìƒˆ ì‹ë‹¨ ì¶”ê°€</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="post" action="/meals">
                        <input type="hidden" name="userId" th:value="${userId}">
                        <input type="hidden" id="selectedMealDate" name="mealDate" required>

                        <input type="text" id="mealFoodName" name="mealFoodName" class="form-control mt-2" placeholder="ìŒì‹ ì´ë¦„ (ì§ì ‘ ì…ë ¥ ê°€ëŠ¥)" required>
                        <input type="number" id="mealCalories" name="totalCalories" class="form-control mt-2" placeholder="ì´ ì¹¼ë¡œë¦¬ (kcal)" required>
                        <input type="number" id="mealCarbs" name="totalCarbs" class="form-control mt-2" placeholder="íƒ„ìˆ˜í™”ë¬¼ (g)" required>
                        <input type="number" id="mealProtein" name="totalProtein" class="form-control mt-2" placeholder="ë‹¨ë°±ì§ˆ (g)" required>
                        <input type="number" id="mealFat" name="totalFat" class="form-control mt-2" placeholder="ì§€ë°© (g)" required>

                        <h6 class="mt-3">ğŸ“Œ ì¶”ê°€ëœ ìŒì‹ ëª©ë¡</h6>
                        <ul id="selectedFoodsList" class="list-group mt-2"></ul>

                        <button type="button" class="btn btn-secondary w-100 mt-2" data-bs-toggle="modal" data-bs-target="#foodModal">ìŒì‹ ì¶”ê°€</button>

                        <button type="submit" class="btn btn-primary mt-3 w-100">ì €ì¥</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- âœ… ì‹ë‹¨ ìˆ˜ì • ëª¨ë‹¬ -->
    <div class="modal fade" id="editMealModal" tabindex="-1" aria-labelledby="editMealModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ì‹ë‹¨ ìˆ˜ì •</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="post" action="/meals/update">
                        <input type="hidden" id="editMealId" name="mealId">
                        <input type="hidden" id="editMealDate" name="mealDate">

                        <label>ì¹¼ë¡œë¦¬</label>
                        <input type="number" id="editTotalCalories" name="totalCalories" class="form-control" required>

                        <label>íƒ„ìˆ˜í™”ë¬¼</label>
                        <input type="number" id="editTotalCarbs" name="totalCarbs" class="form-control" required>

                        <label>ë‹¨ë°±ì§ˆ</label>
                        <input type="number" id="editTotalProtein" name="totalProtein" class="form-control" required>

                        <label>ì§€ë°©</label>
                        <input type="number" id="editTotalFat" name="totalFat" class="form-control" required>

                        <button type="submit" class="btn btn-primary mt-3 w-100">ìˆ˜ì • ì™„ë£Œ</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- âœ… ìŒì‹ ì¶”ê°€ ëª¨ë‹¬ -->
    <div class="modal fade" id="foodModal" tabindex="-1" aria-labelledby="foodModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ìŒì‹ ê²€ìƒ‰</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="foodSearch" class="form-control mt-2" placeholder="ìŒì‹ ì´ë¦„ ê²€ìƒ‰">
                    <button type="button" class="btn btn-primary mt-2" id="searchFoodButton">ê²€ìƒ‰</button>
                    <div id="foodResults" class="mt-2"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    document.addEventListener("DOMContentLoaded", function() {
        let calendarEl = document.getElementById("calendar");
        let selectedDate = new URLSearchParams(window.location.search).get("mealDate"); // âœ… í˜„ì¬ URLì—ì„œ mealDate ê°€ì ¸ì˜¤ê¸°

        let calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: "dayGridMonth",
            selectable: true,
            dateClick: function(info) {
                document.querySelectorAll(".fc-daygrid-day").forEach(day => {
                    day.classList.remove("selected-date");
                });

                let clickedCell = document.querySelector(`[data-date="${info.dateStr}"]`);
                if (clickedCell) {
                    clickedCell.classList.add("selected-date");
                }

                selectedDate = info.dateStr; // âœ… ì„ íƒëœ ë‚ ì§œ ì €ì¥
                document.getElementById("selectedMealDate").value = selectedDate;

                // âœ… ë‚ ì§œ í´ë¦­ ì‹œ í•´ë‹¹ ë‚ ì§œ í˜ì´ì§€ë¡œ ì´ë™
                window.location.href = `/meals?mealDate=${selectedDate}`;
            }
        });

        calendar.render();

        // âœ… í˜„ì¬ ì„ íƒëœ ë‚ ì§œë¥¼ ìœ ì§€í•˜ê¸° ìœ„í•´ selected-date í´ë˜ìŠ¤ ì¶”ê°€
        if (selectedDate) {
            let selectedCell = document.querySelector(`[data-date="${selectedDate}"]`);
            if (selectedCell) {
                selectedCell.classList.add("selected-date");
            }
        }

        // âœ… ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œ, selectedMealDateê°€ ë¹„ì–´ ìˆìœ¼ë©´ í˜„ì¬ ì„ íƒí•œ ë‚ ì§œë¥¼ ë„£ì–´ì¤Œ
        document.getElementById("mealModal").addEventListener("show.bs.modal", function (event) {
            let selectedDateInput = document.getElementById("selectedMealDate");

            if (!selectedDate) { // âœ… ì„ íƒí•œ ë‚ ì§œê°€ ì—†ì„ ê²½ìš° ëª¨ë‹¬ ì—´ë¦¼ ë°©ì§€
                alert("ë‚ ì§œë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”!");
                event.preventDefault(); // ëª¨ë‹¬ì´ ì—´ë¦¬ì§€ ì•Šë„ë¡ ë°©ì§€
                return;
            }

            if (!selectedDateInput.value) {
                selectedDateInput.value = selectedDate;
            }
        });
    });



    document.getElementById("searchFoodButton").addEventListener("click", function() {
        let query = document.getElementById("foodSearch").value;
        fetch(`/foods/search?query=${query}`)
            .then(response => response.json())
            .then(data => {
                let resultsDiv = document.getElementById("foodResults");
                resultsDiv.innerHTML = "";
                data.forEach(food => {
                    let btn = document.createElement("button");
                    btn.className = "btn btn-light w-100 mt-1";
                    btn.textContent = `${food.foodName} (${food.calories} kcal)`;
                    btn.onclick = function() {
                        document.getElementById("mealFoodName").value = food.foodName;
                        document.getElementById("mealCalories").value = food.calories;
                        document.getElementById("mealCarbs").value = food.carbs;
                        document.getElementById("mealProtein").value = food.protein;
                        document.getElementById("mealFat").value = food.fat;

                        let listItem = document.createElement("li");
                        listItem.className = "list-group-item";
                        listItem.textContent = `${food.foodName} (${food.calories} kcal)`;
                        document.getElementById("selectedFoodsList").appendChild(listItem);

                        bootstrap.Modal.getInstance(document.getElementById("foodModal")).hide();
                    };
                    resultsDiv.appendChild(btn);
                });
            });
    });
    
 // âœ… ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì‹œ, ê¸°ì¡´ ë°ì´í„°ê°€ ëª¨ë‹¬ì— ìë™ìœ¼ë¡œ ì±„ì›Œì§
document.addEventListener("click", function(event) {
    let button = event.target.closest(".edit-meal-btn"); // âœ… ë²„íŠ¼ ë‚´ë¶€ ìš”ì†Œ í´ë¦­í•´ë„ ì¸ì‹ ê°€ëŠ¥
    if (button) {
        // âœ… ìˆ˜ì •í•  ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        let mealId = button.getAttribute("data-mealid");
        let mealDate = button.getAttribute("data-mealdate");
        let totalCalories = button.getAttribute("data-totalcalories");
        let totalCarbs = button.getAttribute("data-totalcarbs");
        let totalProtein = button.getAttribute("data-totalprotein");
        let totalFat = button.getAttribute("data-totalfat");

        // âœ… ìˆ˜ì • ëª¨ë‹¬ì— ê°’ ì±„ìš°ê¸°
        document.getElementById("editMealId").value = mealId;
        document.getElementById("editMealDate").value = mealDate;
        document.getElementById("editTotalCalories").value = totalCalories;
        document.getElementById("editTotalCarbs").value = totalCarbs;
        document.getElementById("editTotalProtein").value = totalProtein;
        document.getElementById("editTotalFat").value = totalFat;

        // âœ… ë””ë²„ê¹… ë¡œê·¸ (F12 ê°œë°œì ë„êµ¬ì—ì„œ í™•ì¸ ê°€ëŠ¥)
        console.log("ğŸ“Œ ìˆ˜ì • ë²„íŠ¼ í´ë¦­ë¨");
        console.log("âœ… mealId:", mealId);
        console.log("âœ… mealDate:", mealDate);
    }
});

// âœ… ìˆ˜ì • ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œ ë¡œê·¸ ì¶œë ¥ (ë””ë²„ê¹…ìš©)
let editMealModal = document.querySelector("#editMealModal");
if (editMealModal) {
    editMealModal.addEventListener("show.bs.modal", function() {
        console.log("ğŸ“Œ ìˆ˜ì • ëª¨ë‹¬ì´ ì—´ë ¸ìŠµë‹ˆë‹¤!");
        console.log("âœ… ìˆ˜ì •í•  mealId:", document.getElementById("editMealId").value);
    });
}



    </script>
    

    
</body>
</html>
